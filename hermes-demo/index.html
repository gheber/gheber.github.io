<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-03-26 Fri 09:32 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hermes Demo (10 min)</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Gerd Heber" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Hermes Demo (10 min)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf1bdc8c">Hermes Docker Container(s)</a></li>
<li><a href="#orgae44a70">Demo 1 - Hermes Basics</a>
<ul>
<li><a href="#orgbc87a53">Goal</a></li>
<li><a href="#org1457706">Outline</a></li>
<li><a href="#org64a925a">Boilerplate</a></li>
<li><a href="#org07933af">Hermes <code>main</code></a></li>
<li><a href="#org0f03805">C++ <code>main</code></a></li>
<li><a href="#org0a14512">Do it</a></li>
<li><a href="#orgb4c5984">Sample results</a></li>
</ul>
</li>
<li><a href="#orgd6dabb6">Demo 2 - The UNIX STDIO Adapter</a>
<ul>
<li><a href="#org5075c1c">Goal</a></li>
<li><a href="#org8b5abbe">Code</a></li>
<li><a href="#org2a733df">Sample results</a></li>
</ul>
</li>
<li><a href="#org646ec82">Appendix</a>
<ul>
<li><a href="#orgd70f72d"><code>hermes.conf</code></a></li>
</ul>
</li>
<li><a href="#org80affc3"><code>demo1.cc</code></a></li>
</ul>
</div>
</div>

<div id="outline-container-orgf1bdc8c" class="outline-2">
<h2 id="orgf1bdc8c">Hermes Docker Container(s)</h2>
<div class="outline-text-2" id="text-orgf1bdc8c">
<p>
Most painless way to get started w/ Hermes:
<a href="https://hub.docker.com/repository/docker/hdfgroup/hermes">https://hub.docker.com/repository/docker/hdfgroup/hermes</a>
</p>

<p>
Make sure you allow the container to use a generous amount of shared memory, and
mount all the volumes you'd like to find in the container.
</p>

<div class="org-src-container">
<pre class="src src-sh">
docker run -it --name hermes_container --shm-size 1G <span style="color: #008000;">\</span>
       -v /mnt/hd:/hd -v /mnt/sdcard:/sdcard <span style="color: #008000;">\</span>
       --entrypoint /bin/bash 5239038d60f1

</pre>
</div>
</div>
</div>

<div id="outline-container-orgae44a70" class="outline-2">
<h2 id="orgae44a70">Demo 1 - Hermes Basics</h2>
<div class="outline-text-2" id="text-orgae44a70">
</div>
<div id="outline-container-orgbc87a53" class="outline-3">
<h3 id="orgbc87a53">Goal</h3>
<div class="outline-text-3" id="text-orgbc87a53">
<p>
Demonstrate how to create a bucket and write (<code>Bucket::Put</code>) a sequence of blobs
of a given size using a specified placement strategy, and read (<code>Bucket::Get</code>)
them back.
</p>
</div>
</div>

<div id="outline-container-org1457706" class="outline-3">
<h3 id="org1457706">Outline</h3>
<div class="outline-text-3" id="text-org1457706">
<p>
This is what a "native" Hermes app. looks like, currently.
</p>

<div class="org-src-container">
<pre class="src src-C++">
&lt;&lt;boilerplate&gt;&gt;

<span style="color: #6434A3;">void</span> hermes_app_main(<span style="color: #6434A3;">int</span>* <span style="color: #BA36A5;">argcp</span>, <span style="color: #6434A3;">char</span>*** <span style="color: #BA36A5;">argvp</span>,
                     <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">shared_ptr</span>&lt;<span style="color: #D0372D;">hapi</span>::Hermes&gt; <span style="color: #0000FF;">const</span>&amp; <span style="color: #BA36A5;">hermes</span>)
{
  &lt;&lt;hermes-main&gt;&gt;
}

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span>(<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">argc</span>, <span style="color: #6434A3;">char</span> **<span style="color: #BA36A5;">argv</span>)
{
  &lt;&lt;cpp-main&gt;&gt;
}

</pre>
</div>
</div>
</div>

<div id="outline-container-org64a925a" class="outline-3">
<h3 id="org64a925a">Boilerplate</h3>
<div class="outline-text-3" id="text-org64a925a">
<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #808080;">#include</span> <span style="color: #008000;">"hermes.h"</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">"bucket.h"</span>

<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;cassert&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;chrono&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;cstdint&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;iostream&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;thread&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;vector&gt;</span>

<span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;mpi.h&gt;</span>

<span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">hapi</span> = <span style="color: #D0372D;">hermes</span>::api;

<span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>::<span style="color: #D0372D;">chrono</span>;

</pre>
</div>
</div>
</div>

<div id="outline-container-org07933af" class="outline-3">
<h3 id="org07933af">Hermes <code>main</code></h3>
<div class="outline-text-3" id="text-org07933af">
<p>
Parse arguments and get our "house number."
</p>

<p>
Remember, Hermes does <b>NOT</b> use MPI for communication!
</p>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #0000FF;">if</span> (*argcp != 5)
  exit(-1);

<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">count</span> = (<span style="color: #6434A3;">size_t</span>) atol((*argvp)[1]);
assert(count &gt;= 1);
<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size_mib</span> = (<span style="color: #6434A3;">size_t</span>) atol((*argvp)[2]);
assert(size_mib &gt;= 1);
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">strategy</span> = atoi((*argvp)[3]);
assert(strategy &gt;= 0 &amp;&amp; strategy &lt; 3);

<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">app_rank</span> = hermes-&gt;GetProcessRank();
<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">app_size</span> = hermes-&gt;GetNumProcesses();

<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">my_count</span> = (count - count%app_size) / app_size;

</pre>
</div>

<p>
Create a context and pick a default data placement policy.
</p>

<p>
Create a shared bucket and a 1 MiB "dummy" blob that we'll place multiple times.
</p>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #D0372D;">hapi</span>::<span style="color: #6434A3;">Context</span> <span style="color: #BA36A5;">ctx</span>;

<span style="color: #0000FF;">switch</span> (strategy)
  {
  <span style="color: #0000FF;">case</span> 0:
    ctx.policy = <span style="color: #D0372D;">hapi</span>::<span style="color: #D0372D;">PlacementPolicy</span>::kRandom;
    <span style="color: #0000FF;">break</span>;
  <span style="color: #0000FF;">case</span> 1:
    ctx.policy = <span style="color: #D0372D;">hapi</span>::<span style="color: #D0372D;">PlacementPolicy</span>::kRoundRobin;
    <span style="color: #0000FF;">break</span>;
  <span style="color: #0000FF;">case</span> 2:
    ctx.policy = <span style="color: #D0372D;">hapi</span>::<span style="color: #D0372D;">PlacementPolicy</span>::kMinimizeIoTime;
    <span style="color: #0000FF;">break</span>;
  <span style="color: #0000FF;">default</span>:
    <span style="color: #0000FF;">break</span>;
  }

<span style="color: #D0372D;">hapi</span>::<span style="color: #6434A3;">Bucket</span> <span style="color: #006699;">shared_bucket</span>(<span style="color: #D0372D;">std</span>::string(<span style="color: #008000;">"Share the bucket!"</span>), hermes, ctx);

<span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">vector</span>&lt;<span style="color: #6434A3;">uint8_t</span>&gt; <span style="color: #006699;">MiB</span>(<span style="color: #6434A3;">size_mib</span>*1024*1024);
<span style="color: #6434A3;">uint8_t</span>* <span style="color: #BA36A5;">data</span> = &amp;MiB[0];

</pre>
</div>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">sleep_duration</span> = <span style="color: #D0372D;">std</span>::<span style="color: #D0372D;">chrono</span>::microseconds(150000);
hermes-&gt;AppBarrier();
<span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">start</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now();

</pre>
</div>

<p>
Do a bunch of <code>Bucket::Put</code> operations.
</p>

<p>
<b>Note:</b> There is a vectorized version of <code>Bucket::Put</code>.
</p>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">i</span> = app_rank; i &lt; count; i += app_size)
  {
    <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">blob_name</span> = <span style="color: #008000;">".hermes/"</span> + <span style="color: #D0372D;">std</span>::to_string(i);
    <span style="color: #0000FF;">if</span> (shared_bucket.Put(blob_name, data, MiB.size(), ctx).Failed())
      <span style="color: #0000FF;">throw</span>(<span style="color: #008000;">"What the Bucket::Put?"</span>);
    <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">HACK: Give the system a chance to update its view state!</span>
    <span style="color: #D0372D;">std</span>::<span style="color: #D0372D;">this_thread</span>::sleep_for(sleep_duration);
  }

</pre>
</div>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">elapsed</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
<span style="color: #6434A3;">uint64_t</span> <span style="color: #BA36A5;">us</span> = duration_cast&lt;microseconds&gt;(elapsed).count() -
  my_count * sleep_duration.count();
<span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"Bucket-&gt;Put [us] : "</span> &lt;&lt; us &lt;&lt; <span style="color: #008000;">" : ~"</span>
          &lt;&lt; 1024 * 1024 * size_mib * my_count / us &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;

hermes-&gt;AppBarrier();
start = <span style="color: #D0372D;">high_resolution_clock</span>::now();

</pre>
</div>

<p>
Do a bunch of <code>Bucket::Get</code> operations.
</p>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">i</span> = app_rank; i &lt; count; i += app_size)
  {
    <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">blob_name</span> = <span style="color: #008000;">".hermes/"</span> + <span style="color: #D0372D;">std</span>::to_string(i);
    <span style="color: #0000FF;">if</span> (shared_bucket.Get(blob_name, MiB, ctx) != MiB.size())
      <span style="color: #0000FF;">throw</span>(<span style="color: #008000;">"What the Bucket::Get?"</span>);
  }

</pre>
</div>

<div class="org-src-container">
<pre class="src src-C++">
hermes-&gt;AppBarrier();

elapsed = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
us = duration_cast&lt;microseconds&gt;(elapsed).count();

<span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"Bucket-&gt;Get [us] : "</span> &lt;&lt; us &lt;&lt; <span style="color: #008000;">" : ~"</span>
          &lt;&lt; 1024 * 1024 * size_mib * my_count / us &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;

shared_bucket.Close(ctx);

</pre>
</div>
</div>
</div>

<div id="outline-container-org0f03805" class="outline-3">
<h3 id="org0f03805">C++ <code>main</code></h3>
<div class="outline-text-3" id="text-org0f03805">
<p>
Make sure we have the right capabilities. Remember that we do <b>NOT</b> use MPI for
communication. We just use the mechanics to spawn processes.
</p>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #0000FF;">try</span>
  {
    <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">mpi_threads_provided</span>;
    MPI_Init_thread(&amp;argc, &amp;argv, MPI_THREAD_MULTIPLE,
                    &amp;mpi_threads_provided);
    <span style="color: #0000FF;">if</span> (mpi_threads_provided &lt; MPI_THREAD_MULTIPLE)
      {
        <span style="color: #D0372D;">std</span>::cerr &lt;&lt; <span style="color: #008000;">"Didn't receive appropriate MPI threading spec.\n"</span>;
        <span style="color: #0000FF;">return</span> 1;
      }

    <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">config_file</span> = 0;
    <span style="color: #0000FF;">if</span> (argc == 5)
      config_file = argv[argc-1];
    <span style="color: #0000FF;">else</span>
      {
        <span style="color: #D0372D;">std</span>::cerr &lt;&lt; <span style="color: #008000;">"demo &lt;blob_count&gt; &lt;blob_size_mib&gt; "</span>
                  &lt;&lt; <span style="color: #008000;">"&lt;placement_strategy&gt; &lt;hermes_config&gt; !\n"</span>;
        exit(-1);
      }

</pre>
</div>

<p>
In Hermes, there are two kinds of processes, processes that execute application
code and processes that perform Hermes system functions.
</p>

<p>
We measure the time application processes spend in <code>hermes-&gt;Finalize</code>, which is
essentially flushing buffers.
</p>

<div class="org-src-container">
<pre class="src src-C++">
<span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">shared_ptr</span>&lt;<span style="color: #D0372D;">hapi</span>::Hermes&gt; <span style="color: #BA36A5;">hermes</span> = <span style="color: #D0372D;">hapi</span>::InitHermes(config_file);

<span style="color: #0000FF;">if</span> (hermes-&gt;IsApplicationCore())
  {
    hermes_app_main(&amp;argc, &amp;argv, hermes);

    <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">app_size</span> = hermes-&gt;GetNumProcesses();
    <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">start</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now();

    hermes-&gt;Finalize();

    <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">elapsed</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
    <span style="color: #6434A3;">uint64_t</span> <span style="color: #BA36A5;">us</span> = duration_cast&lt;microseconds&gt;(elapsed).count();

    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"hermes-&gt;Finalize [us] : "</span> &lt;&lt; us &lt;&lt; <span style="color: #008000;">" : ~"</span>
              &lt;&lt; (<span style="color: #6434A3;">size_t</span>) (atol(argv[1])*atol(argv[2])*1024*1024 /
                           (app_size * us)) &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;
  }
<span style="color: #0000FF;">else</span>
  hermes-&gt;Finalize();

</pre>
</div>

<div class="org-src-container">
<pre class="src src-C++">
    MPI_Finalize();
  }
<span style="color: #0000FF;">catch</span> (<span style="color: #0000FF;">const</span> <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">exception</span>&amp; <span style="color: #BA36A5;">e</span>)
  {
    <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">" a standard exception was caught, with message '"</span>
              &lt;&lt; e.what() &lt;&lt; <span style="color: #008000;">"'\n"</span>;
  }

<span style="color: #0000FF;">return</span> 0;

</pre>
</div>
</div>
</div>

<div id="outline-container-org0a14512" class="outline-3">
<h3 id="org0a14512">Do it</h3>
<div class="outline-text-3" id="text-org0a14512">
<pre class="example" id="org06e8765">

demo1 &lt;blob_count&gt; &lt;blob_size_mib&gt; &lt;placement_strategy&gt; &lt;hermes_config&gt;

</pre>

<p>
<span class="underline">Placement strategies</span>:
</p>

<dl class="org-dl">
<dt>0</dt><dd>Random placement</dd>
<dt>1</dt><dd>Round-robin</dd>
<dt>2</dt><dd>Linear programming</dd>
</dl>

<div class="org-src-container">
<pre class="src src-sh">
mpiexec -n 4 demo1 32 4 0 ./hermes.conf 2&gt;&amp;1 | tee stdout.xt | grep <span style="color: #008000;">"\[us\]"</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4c5984" class="outline-3">
<h3 id="orgb4c5984">Sample results</h3>
<div class="outline-text-3" id="text-orgb4c5984">
<pre class="example" id="orgcdd9d61">
hermes@d69a3f7ab649:~$ mpiexec -n 4 ./source/build/bin/demo1 32 4 0 \
                         ./hermes.conf 2&gt;&amp;1 | tee stdout.xt | grep "\[us\]"
Bucket-&gt;Put [us] : 109585 : ~408 MB/s
Bucket-&gt;Put [us] : 283296 : ~157 MB/s
Bucket-&gt;Put [us] : 295500 : ~151 MB/s
Bucket-&gt;Get [us] : 14239 : ~3142 MB/s
Bucket-&gt;Get [us] : 16460 : ~2718 MB/s
Bucket-&gt;Get [us] : 17578 : ~2545 MB/s
hermes-&gt;Finalize [us] : 8281338 : ~5 MB/s
hermes-&gt;Finalize [us] : 8284611 : ~5 MB/s
hermes-&gt;Finalize [us] : 8282374 : ~5 MB/s

hermes@d69a3f7ab649:~$ mpiexec -n 4 ./source/build/bin/demo1 32 4 1 \
                         ./hermes.conf 2&gt;&amp;1 | tee stdout.xt | grep "\[us\]"
Bucket-&gt;Put [us] : 111854 : ~399 MB/s
Bucket-&gt;Put [us] : 238306 : ~187 MB/s
Bucket-&gt;Put [us] : 276623 : ~161 MB/s
Bucket-&gt;Get [us] : 13842 : ~3232 MB/s
Bucket-&gt;Get [us] : 14838 : ~3015 MB/s
Bucket-&gt;Get [us] : 15763 : ~2838 MB/s
hermes-&gt;Finalize [us] : 7954699 : ~5 MB/s
hermes-&gt;Finalize [us] : 7955607 : ~5 MB/s
hermes-&gt;Finalize [us] : 7956513 : ~5 MB/s

hermes@d69a3f7ab649:~$ mpiexec -n 4 ./source/build/bin/demo1 32 4 2 \
                         ./hermes.conf 2&gt;&amp;1 | tee stdout.xt | grep "\[us\]"
Bucket-&gt;Put [us] : 115891 : ~386 MB/s
Bucket-&gt;Put [us] : 253087 : ~176 MB/s
Bucket-&gt;Put [us] : 256169 : ~174 MB/s
Bucket-&gt;Get [us] : 13544 : ~3303 MB/s
Bucket-&gt;Get [us] : 14853 : ~3012 MB/s
Bucket-&gt;Get [us] : 15710 : ~2847 MB/s
hermes-&gt;Finalize [us] : 23256456 : ~1 MB/s
hermes-&gt;Finalize [us] : 23257266 : ~1 MB/s
hermes-&gt;Finalize [us] : 23258535 : ~1 MB/s

</pre>
</div>
</div>
</div>

<div id="outline-container-orgd6dabb6" class="outline-2">
<h2 id="orgd6dabb6">Demo 2 - The UNIX STDIO Adapter</h2>
<div class="outline-text-2" id="text-orgd6dabb6">
</div>
<div id="outline-container-org5075c1c" class="outline-3">
<h3 id="org5075c1c">Goal</h3>
<div class="outline-text-3" id="text-org5075c1c">
<p>
Demonstrate the use of the UNIX STDIO adapter by intercepting <code>fopen</code>, <code>fwrite</code>, and <code>fclose</code>.
</p>
</div>
</div>

<div id="outline-container-org8b5abbe" class="outline-3">
<h3 id="org8b5abbe">Code</h3>
<div class="outline-text-3" id="text-org8b5abbe">
<p>
Create a file w/ <code>fopen</code> and write a few bytes w/ <code>fwrite</code>. Hermes intercepts
the calls and ensures the right things are happening.
</p>

<div class="org-src-container">
<pre class="src src-C++"><span class="linenr"> 1: </span>
<span class="linenr"> 2: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;cassert&gt;</span>
<span class="linenr"> 3: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;chrono&gt;</span>
<span class="linenr"> 4: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;cstdio&gt;</span>
<span class="linenr"> 5: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;cstdlib&gt;</span>
<span class="linenr"> 6: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;iostream&gt;</span>
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">"mpi.h"</span>
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>::<span style="color: #D0372D;">chrono</span>;
<span class="linenr">11: </span>
<span class="linenr">12: </span><span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span>(<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">argc</span>, <span style="color: #6434A3;">char</span>** <span style="color: #BA36A5;">argv</span>)
<span class="linenr">13: </span>{
<span class="linenr">14: </span>  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">HACK: This is an artifact of how we are currently deploying Hermes.</span>
<span class="linenr">15: </span>  MPI_Init(&amp;argc, &amp;argv);
<span class="linenr">16: </span>
<span class="linenr">17: </span>  <span style="color: #6434A3;">FILE</span>* <span style="color: #BA36A5;">fp</span>;
<span class="linenr">18: </span>  assert((fp = fopen(<span style="color: #008000;">"foo.bytes"</span>, <span style="color: #008000;">"w+"</span>)) != <span style="color: #D0372D;">NULL</span>);
<span class="linenr">19: </span>
<span class="linenr">20: </span>  <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size</span> = 4096;
<span class="linenr">21: </span>  <span style="color: #0000FF;">if</span> (argc == 2)
<span class="linenr">22: </span>    size = (<span style="color: #6434A3;">size_t</span>) atol(argv[1]);
<span class="linenr">23: </span>
<span class="linenr">24: </span>  <span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span>* <span style="color: #BA36A5;">buf</span> = (<span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span>*) malloc(size);
<span class="linenr">25: </span>  assert(buf != <span style="color: #D0372D;">NULL</span>);
<span class="linenr">26: </span>
<span class="linenr">27: </span>  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">start</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now();
<span class="linenr">28: </span>
<span class="linenr">29: </span>  assert(fwrite(buf, <span style="color: #0000FF;">sizeof</span>(<span style="color: #6434A3;">unsigned</span> <span style="color: #6434A3;">char</span>), size, fp) == size);
<span class="linenr">30: </span>
<span class="linenr">31: </span>  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">elapsed</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
<span class="linenr">32: </span>  <span style="color: #6434A3;">uint64_t</span> <span style="color: #BA36A5;">us1</span> = duration_cast&lt;microseconds&gt;(elapsed).count();
<span class="linenr">33: </span>
<span class="linenr">34: </span>  assert(fclose(fp) == 0);
<span class="linenr">35: </span>  elapsed = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
<span class="linenr">36: </span>  <span style="color: #6434A3;">uint64_t</span> <span style="color: #BA36A5;">us2</span> = duration_cast&lt;microseconds&gt;(elapsed).count();
<span class="linenr">37: </span>
<span class="linenr">38: </span>  <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"fwrite [us] : "</span> &lt;&lt; us1 &lt;&lt; <span style="color: #008000;">" : ~"</span> &lt;&lt; size / us1 &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;
<span class="linenr">39: </span>  <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"fwrite+fclose [us] : "</span> &lt;&lt; us2 &lt;&lt; <span style="color: #008000;">" : ~"</span> &lt;&lt; size / us2
<span class="linenr">40: </span>            &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;
<span class="linenr">41: </span>
<span class="linenr">42: </span>  free(buf);
<span class="linenr">43: </span>
<span class="linenr">44: </span>  <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">HACK: Again...</span>
<span class="linenr">45: </span>  MPI_Finalize();
<span class="linenr">46: </span>
<span class="linenr">47: </span>  <span style="color: #0000FF;">return</span> 0;
<span class="linenr">48: </span>}
<span class="linenr">49: </span>
</pre>
</div>

<p>
Run it!
</p>

<div class="org-src-container">
<pre class="src src-sh">
<span style="color: #BA36A5;">LD_PRELOAD</span>=libhermes_stdio.so demo2 $((2048*1024*1024)) &gt; stdout.txt 2&gt;&amp;1

</pre>
</div>
</div>
</div>

<div id="outline-container-org2a733df" class="outline-3">
<h3 id="org2a733df">Sample results</h3>
<div class="outline-text-3" id="text-org2a733df">
<pre class="example" id="org7480a3e">

hermes@991d97cb00f1:~/source/build$ LD_PRELAOD=libhermes_stdio.so ./bin/demo2 \
  $((2048*1024*1024)) 2&gt;&amp;1 | tee stdout.txt | grep "\[us\]"
fwrite [us] : 405653 : ~5293 MB/s
fwrite+fclose [us] : 1570303 : ~1367 MB/s

</pre>
</div>
</div>
</div>


<div id="outline-container-org646ec82" class="outline-2">
<h2 id="org646ec82">Appendix</h2>
<div class="outline-text-2" id="text-org646ec82">
</div>
<div id="outline-container-orgd70f72d" class="outline-3">
<h3 id="orgd70f72d"><code>hermes.conf</code></h3>
<div class="outline-text-3" id="text-orgd70f72d">
<pre class="example" id="org7a4cb03">

# The number of buffering tiers available. For example, RAM, NVMe, burst
# buffer, and parallel file system would be 4 tiers.
num_devices = 4;

# For now this should be the same as num_devices.
num_targets = 4;

# The maximum buffering capacity in MiB of each device.
capacities_mb = {128, 1024, 4096, 4096};

# The size of the smallest available buffer in KiB. In general this should be
# the page size of your system for byte addressable storage, and the block
# size of the storage device for block addressable storage.
block_sizes_kb = {4, 4, 256, 1024};

# The number of different buffers a device should have.
num_slabs = {4, 4, 2, 2};

# The number of blocks (the size of which is chosen in block_sizes_kb) that
# each device should contain for each slab (controlled by num_slabs). This
# allows for precise control of the distibution of buffer sizes.
slab_unit_sizes = {
  {1, 4, 16, 32},
  {1, 4, 16, 32},
  {1, 4},
  {1, 8},
};

# The percentage of buffering capacity per device to allocate for each slab.
# Each row should add up to 1.
desired_slab_percentages = {
  {0.25, 0.25, 0.25, 0.25},
  {0.25, 0.25, 0.25, 0.25},
  {0.75, 0.25},
  {0.75, 0.25},
};

# The maximum theoretical bandwidth (as advertised by the manufacturer) in
# MiB/sec. of each device.
bandwidths_mbps = {6000, 300, 35, 5};

# The latency in microseconds of each device (as advertised by the
# manufactuerer).
latencies_us = {15, 250000, 500000, 1000000};

# Hermes memory management. The following 4 values should add up to 1.
# The percentage of Hermes memory to reserve for RAM buffers.
buffer_pool_arena_percentage = 0.85;
# The percentage of Hermes memory to reserve for metadata.
metadata_arena_percentage = 0.04;
# The percentage of Hermes memory to reserve for data transfers.
transfer_window_arena_percentage = 0.08;
# The percentage of Hermes memory to reserve for short term storage.
transient_arena_percentage = 0.03;

# The maxiumum number of buckets that can be created.
max_buckets_per_node = 16;
# The maxiumum number of virtual buckets that can be created.
max_vbuckets_per_node = 8;
# The interval in milliseconds at which to update the global system view.
system_view_state_update_interval_ms = 100;

# The mount point of each device. RAM should be the empty string. For block
# devices, this is the directory where Hermes will create buffering files. For
# object storage or cloud targets, this will be a url.
mount_points = {"", "./", "/hd", "/sdcard"};
# The mount point of a PFS or object store for swap space, in the event that
# Hermes buffers become full.
swap_mount = "/sdcard";
# The number of times the buffer organizer will attempt to place a blob from
# swap space into the hierarchy before giving up.
num_buffer_organizer_retries = 3;
# Base hostname for the RPC servers.
rpc_server_base_name = "localhost";
# RPC server name suffix. This is appended to the the base name plus host
# number.
rpc_server_suffix = "";
# The RPC protocol. This must come from the documentation of the specific RPC
# library in use.
rpc_protocol = "ofi+sockets";
# RPC domain name for verbs transport. Blank for tcp.
rpc_domain = "";
# Desired RPC port number.
rpc_port = 8080;
# Desired RPC port number for buffer organizer.
buffer_organizer_port = 8081;
# An inclusive range of the first and last server numbers. This is a convenience
# feature for generating long lists of server names. For example, if your
# servers are called server-1-40g, server-2-40g, server-3-40g, all the way to
# server-100-40g, then you would set rpc_server_base_name to 'server',
# rpc_server_suffix to '-40g', and rpc_host_number_range to {1, 100}.
# TODO(chogan): Support reading server names from file.
rpc_host_number_range = {0, 0};
# The number of handler threads for each RPC server.
rpc_num_threads = 1;
# The shared memory prefix for the hermes shared memory segment. A user name
# will be automatically appended.
buffer_pool_shmem_name = "/hermes_buffer_pool_";
</pre>
</div>
</div>
</div>

<div id="outline-container-org80affc3" class="outline-2">
<h2 id="org80affc3"><code>demo1.cc</code></h2>
<div class="outline-text-2" id="text-org80affc3">
<div class="org-src-container">
<pre class="src src-C++"><span class="linenr">  1: </span>
<span class="linenr">  2: </span>
<span class="linenr">  3: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">"hermes.h"</span>
<span class="linenr">  4: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">"bucket.h"</span>
<span class="linenr">  5: </span>
<span class="linenr">  6: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;cassert&gt;</span>
<span class="linenr">  7: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;chrono&gt;</span>
<span class="linenr">  8: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;cstdint&gt;</span>
<span class="linenr">  9: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;iostream&gt;</span>
<span class="linenr"> 10: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;thread&gt;</span>
<span class="linenr"> 11: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;vector&gt;</span>
<span class="linenr"> 12: </span>
<span class="linenr"> 13: </span><span style="color: #808080;">#include</span> <span style="color: #008000;">&lt;mpi.h&gt;</span>
<span class="linenr"> 14: </span>
<span class="linenr"> 15: </span><span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">hapi</span> = <span style="color: #D0372D;">hermes</span>::api;
<span class="linenr"> 16: </span>
<span class="linenr"> 17: </span><span style="color: #0000FF;">using</span> <span style="color: #0000FF;">namespace</span> <span style="color: #D0372D;">std</span>::<span style="color: #D0372D;">chrono</span>;
<span class="linenr"> 18: </span>
<span class="linenr"> 19: </span>
<span class="linenr"> 20: </span><span style="color: #6434A3;">void</span> <span style="color: #006699;">hermes_app_main</span>(<span style="color: #6434A3;">int</span>* <span style="color: #BA36A5;">argcp</span>, <span style="color: #6434A3;">char</span>*** <span style="color: #BA36A5;">argvp</span>,
<span class="linenr"> 21: </span>                     <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">shared_ptr</span>&lt;<span style="color: #D0372D;">hapi</span>::Hermes&gt; <span style="color: #0000FF;">const</span>&amp; <span style="color: #BA36A5;">hermes</span>)
<span class="linenr"> 22: </span>{
<span class="linenr"> 23: </span>
<span class="linenr"> 24: </span>  <span style="color: #0000FF;">if</span> (*argcp != 5)
<span class="linenr"> 25: </span>    exit(-1);
<span class="linenr"> 26: </span>
<span class="linenr"> 27: </span>  <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">count</span> = (<span style="color: #6434A3;">size_t</span>) atol((*argvp)[1]);
<span class="linenr"> 28: </span>  assert(count &gt;= 1);
<span class="linenr"> 29: </span>  <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">size_mib</span> = (<span style="color: #6434A3;">size_t</span>) atol((*argvp)[2]);
<span class="linenr"> 30: </span>  assert(size_mib &gt;= 1);
<span class="linenr"> 31: </span>  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">strategy</span> = atoi((*argvp)[3]);
<span class="linenr"> 32: </span>  assert(strategy &gt;= 0 &amp;&amp; strategy &lt; 3);
<span class="linenr"> 33: </span>
<span class="linenr"> 34: </span>  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">app_rank</span> = hermes-&gt;GetProcessRank();
<span class="linenr"> 35: </span>  <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">app_size</span> = hermes-&gt;GetNumProcesses();
<span class="linenr"> 36: </span>
<span class="linenr"> 37: </span>  <span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">my_count</span> = (count - count%app_size) / app_size;
<span class="linenr"> 38: </span>
<span class="linenr"> 39: </span>
<span class="linenr"> 40: </span>  <span style="color: #D0372D;">hapi</span>::<span style="color: #6434A3;">Context</span> <span style="color: #BA36A5;">ctx</span>;
<span class="linenr"> 41: </span>
<span class="linenr"> 42: </span>  <span style="color: #0000FF;">switch</span> (strategy)
<span class="linenr"> 43: </span>    {
<span class="linenr"> 44: </span>    <span style="color: #0000FF;">case</span> 0:
<span class="linenr"> 45: </span>      ctx.policy = <span style="color: #D0372D;">hapi</span>::<span style="color: #D0372D;">PlacementPolicy</span>::kRandom;
<span class="linenr"> 46: </span>      <span style="color: #0000FF;">break</span>;
<span class="linenr"> 47: </span>    <span style="color: #0000FF;">case</span> 1:
<span class="linenr"> 48: </span>      ctx.policy = <span style="color: #D0372D;">hapi</span>::<span style="color: #D0372D;">PlacementPolicy</span>::kRoundRobin;
<span class="linenr"> 49: </span>      <span style="color: #0000FF;">break</span>;
<span class="linenr"> 50: </span>    <span style="color: #0000FF;">case</span> 2:
<span class="linenr"> 51: </span>      ctx.policy = <span style="color: #D0372D;">hapi</span>::<span style="color: #D0372D;">PlacementPolicy</span>::kMinimizeIoTime;
<span class="linenr"> 52: </span>      <span style="color: #0000FF;">break</span>;
<span class="linenr"> 53: </span>    <span style="color: #0000FF;">default</span>:
<span class="linenr"> 54: </span>      <span style="color: #0000FF;">break</span>;
<span class="linenr"> 55: </span>    }
<span class="linenr"> 56: </span>
<span class="linenr"> 57: </span>  <span style="color: #D0372D;">hapi</span>::<span style="color: #6434A3;">Bucket</span> <span style="color: #BA36A5;">shared_bucket</span>(<span style="color: #D0372D;">std</span>::string(<span style="color: #008000;">"Share the bucket!"</span>), hermes, ctx);
<span class="linenr"> 58: </span>
<span class="linenr"> 59: </span>  <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">vector</span>&lt;<span style="color: #6434A3;">uint8_t</span>&gt; <span style="color: #BA36A5;">MiB</span>(size_mib*1024*1024);
<span class="linenr"> 60: </span>  <span style="color: #6434A3;">uint8_t</span>* <span style="color: #BA36A5;">data</span> = &amp;MiB[0];
<span class="linenr"> 61: </span>
<span class="linenr"> 62: </span>
<span class="linenr"> 63: </span>  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">sleep_duration</span> = <span style="color: #D0372D;">std</span>::<span style="color: #D0372D;">chrono</span>::microseconds(150000);
<span class="linenr"> 64: </span>  hermes-&gt;AppBarrier();
<span class="linenr"> 65: </span>  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">start</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now();
<span class="linenr"> 66: </span>
<span class="linenr"> 67: </span>
<span class="linenr"> 68: </span>  <span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">i</span> = app_rank; i &lt; count; i += app_size)
<span class="linenr"> 69: </span>    {
<span class="linenr"> 70: </span>      <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">blob_name</span> = <span style="color: #008000;">".hermes/"</span> + <span style="color: #D0372D;">std</span>::to_string(i);
<span class="linenr"> 71: </span>      <span style="color: #0000FF;">if</span> (shared_bucket.Put(blob_name, data, MiB.size(), ctx).Failed())
<span class="linenr"> 72: </span>        <span style="color: #0000FF;">throw</span>(<span style="color: #008000;">"What the Bucket::Put?"</span>);
<span class="linenr"> 73: </span>      <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">HACK: Give the system a chance to update its view state!</span>
<span class="linenr"> 74: </span>      <span style="color: #D0372D;">std</span>::<span style="color: #D0372D;">this_thread</span>::sleep_for(sleep_duration);
<span class="linenr"> 75: </span>    }
<span class="linenr"> 76: </span>
<span class="linenr"> 77: </span>
<span class="linenr"> 78: </span>  <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">elapsed</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
<span class="linenr"> 79: </span>  <span style="color: #6434A3;">uint64_t</span> <span style="color: #BA36A5;">us</span> = duration_cast&lt;microseconds&gt;(elapsed).count() -
<span class="linenr"> 80: </span>    my_count * sleep_duration.count();
<span class="linenr"> 81: </span>  <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"Bucket-&gt;Put [us] : "</span> &lt;&lt; us &lt;&lt; <span style="color: #008000;">" : ~"</span>
<span class="linenr"> 82: </span>            &lt;&lt; 1024 * 1024 * size_mib * my_count / us &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;
<span class="linenr"> 83: </span>
<span class="linenr"> 84: </span>  hermes-&gt;AppBarrier();
<span class="linenr"> 85: </span>  start = <span style="color: #D0372D;">high_resolution_clock</span>::now();
<span class="linenr"> 86: </span>
<span class="linenr"> 87: </span>
<span class="linenr"> 88: </span>  <span style="color: #0000FF;">for</span> (<span style="color: #6434A3;">size_t</span> <span style="color: #BA36A5;">i</span> = app_rank; i &lt; count; i += app_size)
<span class="linenr"> 89: </span>    {
<span class="linenr"> 90: </span>      <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">string</span> <span style="color: #BA36A5;">blob_name</span> = <span style="color: #008000;">".hermes/"</span> + <span style="color: #D0372D;">std</span>::to_string(i);
<span class="linenr"> 91: </span>      <span style="color: #0000FF;">if</span> (shared_bucket.Get(blob_name, MiB, ctx) != MiB.size())
<span class="linenr"> 92: </span>        <span style="color: #0000FF;">throw</span>(<span style="color: #008000;">"What the Bucket::Get?"</span>);
<span class="linenr"> 93: </span>    }
<span class="linenr"> 94: </span>
<span class="linenr"> 95: </span>
<span class="linenr"> 96: </span>  hermes-&gt;AppBarrier();
<span class="linenr"> 97: </span>
<span class="linenr"> 98: </span>  elapsed = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
<span class="linenr"> 99: </span>  us = duration_cast&lt;microseconds&gt;(elapsed).count();
<span class="linenr">100: </span>
<span class="linenr">101: </span>  <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"Bucket-&gt;Get [us] : "</span> &lt;&lt; us &lt;&lt; <span style="color: #008000;">" : ~"</span>
<span class="linenr">102: </span>            &lt;&lt; 1024 * 1024 * size_mib * my_count / us &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;
<span class="linenr">103: </span>
<span class="linenr">104: </span>  shared_bucket.Close(ctx);
<span class="linenr">105: </span>
<span class="linenr">106: </span>}
<span class="linenr">107: </span>
<span class="linenr">108: </span><span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span>(<span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">argc</span>, <span style="color: #6434A3;">char</span> **<span style="color: #BA36A5;">argv</span>)
<span class="linenr">109: </span>{
<span class="linenr">110: </span>
<span class="linenr">111: </span>  <span style="color: #0000FF;">try</span>
<span class="linenr">112: </span>    {
<span class="linenr">113: </span>      <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">mpi_threads_provided</span>;
<span class="linenr">114: </span>      MPI_Init_thread(&amp;argc, &amp;argv, MPI_THREAD_MULTIPLE,
<span class="linenr">115: </span>                      &amp;mpi_threads_provided);
<span class="linenr">116: </span>      <span style="color: #0000FF;">if</span> (mpi_threads_provided &lt; MPI_THREAD_MULTIPLE)
<span class="linenr">117: </span>        {
<span class="linenr">118: </span>          <span style="color: #D0372D;">std</span>::cerr &lt;&lt; <span style="color: #008000;">"Didn't receive appropriate MPI threading spec.\n"</span>;
<span class="linenr">119: </span>          <span style="color: #0000FF;">return</span> 1;
<span class="linenr">120: </span>        }
<span class="linenr">121: </span>
<span class="linenr">122: </span>      <span style="color: #6434A3;">char</span> *<span style="color: #BA36A5;">config_file</span> = 0;
<span class="linenr">123: </span>      <span style="color: #0000FF;">if</span> (argc == 5)
<span class="linenr">124: </span>        config_file = argv[argc-1];
<span class="linenr">125: </span>      <span style="color: #0000FF;">else</span>
<span class="linenr">126: </span>        {
<span class="linenr">127: </span>          <span style="color: #D0372D;">std</span>::cerr &lt;&lt; <span style="color: #008000;">"demo &lt;blob_count&gt; &lt;blob_size_mib&gt; "</span>
<span class="linenr">128: </span>                    &lt;&lt; <span style="color: #008000;">"&lt;placement_strategy&gt; &lt;hermes_config&gt; !\n"</span>;
<span class="linenr">129: </span>          exit(-1);
<span class="linenr">130: </span>        }
<span class="linenr">131: </span>
<span class="linenr">132: </span>
<span class="linenr">133: </span>  <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">shared_ptr</span>&lt;<span style="color: #D0372D;">hapi</span>::Hermes&gt; <span style="color: #BA36A5;">hermes</span> = <span style="color: #D0372D;">hapi</span>::InitHermes(config_file);
<span class="linenr">134: </span>
<span class="linenr">135: </span>  <span style="color: #0000FF;">if</span> (hermes-&gt;IsApplicationCore())
<span class="linenr">136: </span>    {
<span class="linenr">137: </span>      hermes_app_main(&amp;argc, &amp;argv, hermes);
<span class="linenr">138: </span>
<span class="linenr">139: </span>      <span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">app_size</span> = hermes-&gt;GetNumProcesses();
<span class="linenr">140: </span>      <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">start</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now();
<span class="linenr">141: </span>
<span class="linenr">142: </span>      hermes-&gt;Finalize();
<span class="linenr">143: </span>
<span class="linenr">144: </span>      <span style="color: #0000FF;">auto</span> <span style="color: #BA36A5;">elapsed</span> = <span style="color: #D0372D;">high_resolution_clock</span>::now() - start;
<span class="linenr">145: </span>      <span style="color: #6434A3;">uint64_t</span> <span style="color: #BA36A5;">us</span> = duration_cast&lt;microseconds&gt;(elapsed).count();
<span class="linenr">146: </span>
<span class="linenr">147: </span>      <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">"hermes-&gt;Finalize [us] : "</span> &lt;&lt; us &lt;&lt; <span style="color: #008000;">" : ~"</span>
<span class="linenr">148: </span>                &lt;&lt; (<span style="color: #6434A3;">size_t</span>) (atol(argv[1])*atol(argv[2])*1024*1024 /
<span class="linenr">149: </span>                             (app_size * us)) &lt;&lt; <span style="color: #008000;">" MB/s\n"</span>;
<span class="linenr">150: </span>    }
<span class="linenr">151: </span>  <span style="color: #0000FF;">else</span>
<span class="linenr">152: </span>    hermes-&gt;Finalize();
<span class="linenr">153: </span>
<span class="linenr">154: </span>
<span class="linenr">155: </span>      MPI_Finalize();
<span class="linenr">156: </span>    }
<span class="linenr">157: </span>  <span style="color: #0000FF;">catch</span> (<span style="color: #0000FF;">const</span> <span style="color: #D0372D;">std</span>::<span style="color: #6434A3;">exception</span>&amp; <span style="color: #BA36A5;">e</span>)
<span class="linenr">158: </span>    {
<span class="linenr">159: </span>      <span style="color: #D0372D;">std</span>::cout &lt;&lt; <span style="color: #008000;">" a standard exception was caught, with message '"</span>
<span class="linenr">160: </span>                &lt;&lt; e.what() &lt;&lt; <span style="color: #008000;">"'\n"</span>;
<span class="linenr">161: </span>    }
<span class="linenr">162: </span>
<span class="linenr">163: </span>  <span style="color: #0000FF;">return</span> 0;
<span class="linenr">164: </span>
<span class="linenr">165: </span>}
<span class="linenr">166: </span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2021-03-26 Fri 00:00</p>
<p class="author">Author: Gerd Heber</p>
<p class="date">Created: 2021-03-26 Fri 09:32</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
